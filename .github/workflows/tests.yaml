name: Chaos tests

env:
  WEAVIATE_VERSION: preview-prepare-release-v1-20-5-db7a300
  MINIMUM_WEAVIATE_VERSION: 1.15.0 # this is used as the start in the upgrade journey test
on:
  push
  
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: psf/black@stable
  01-ann-benchmarks-pq-glove-aws:
    name: "[bench AWS] Glove100 pq=true"
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY}}
      AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
      DATASET: glove-100-angular
      DISTANCE: cosine
      REQUIRED_RECALL: 0.89
    steps:
      - uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}
      - id: 'gcs_auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: ${{secrets.GCP_SERVICE_ACCOUNT_BENCHMARKS}}
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
      - name: Run chaos test
        run: ./ann_benchmark_compression_aws.sh
      - id: 'upload-files'
        uses: 'google-github-actions/upload-cloud-storage@v1'
        with:
          path: 'results'
          destination: 'ann-pipelines/github-action-runs'
          glob: '*.json'
  02-ann-benchmarks-pq-glove-aws:
    name: "[bench AWS] Glove100 pq=true"
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY}}
      AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
      DATASET: glove-100-angular
      DISTANCE: cosine
      REQUIRED_RECALL: 0.89
    steps:
      - uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}
      - id: 'gcs_auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: ${{secrets.GCP_SERVICE_ACCOUNT_BENCHMARKS}}
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
      - name: Run chaos test
        run: ./ann_benchmark_compression_aws.sh
      - id: 'upload-files'
        uses: 'google-github-actions/upload-cloud-storage@v1'
        with:
          path: 'results'
          destination: 'ann-pipelines/github-action-runs'
          glob: '*.json'
  03-ann-benchmarks-pq-glove-aws:
    name: "[bench AWS] Glove100 pq=true"
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY}}
      AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
      DATASET: glove-100-angular
      DISTANCE: cosine
      REQUIRED_RECALL: 0.89
    steps:
      - uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}
      - id: 'gcs_auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: ${{secrets.GCP_SERVICE_ACCOUNT_BENCHMARKS}}
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
      - name: Run chaos test
        run: ./ann_benchmark_compression_aws.sh
      - id: 'upload-files'
        uses: 'google-github-actions/upload-cloud-storage@v1'
        with:
          path: 'results'
          destination: 'ann-pipelines/github-action-runs'
          glob: '*.json'
  04-ann-benchmarks-pq-glove-aws:
    name: "[bench AWS] Glove100 pq=true"
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY}}
      AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
      DATASET: glove-100-angular
      DISTANCE: cosine
      REQUIRED_RECALL: 0.89
    steps:
      - uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}
      - id: 'gcs_auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: ${{secrets.GCP_SERVICE_ACCOUNT_BENCHMARKS}}
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
      - name: Run chaos test
        run: ./ann_benchmark_compression_aws.sh
      - id: 'upload-files'
        uses: 'google-github-actions/upload-cloud-storage@v1'
        with:
          path: 'results'
          destination: 'ann-pipelines/github-action-runs'
          glob: '*.json'
  05-ann-benchmarks-pq-glove-aws:
    name: "[bench AWS] Glove100 pq=true"
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY}}
      AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
      DATASET: glove-100-angular
      DISTANCE: cosine
      REQUIRED_RECALL: 0.89
    steps:
      - uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}
      - id: 'gcs_auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: ${{secrets.GCP_SERVICE_ACCOUNT_BENCHMARKS}}
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
      - name: Run chaos test
        run: ./ann_benchmark_compression_aws.sh
      - id: 'upload-files'
        uses: 'google-github-actions/upload-cloud-storage@v1'
        with:
          path: 'results'
          destination: 'ann-pipelines/github-action-runs'
          glob: '*.json'
  06-ann-benchmarks-pq-glove-aws:
    name: "[bench AWS] Glove100 pq=true"
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY}}
      AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
      DATASET: glove-100-angular
      DISTANCE: cosine
      REQUIRED_RECALL: 0.89
    steps:
      - uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}
      - id: 'gcs_auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: ${{secrets.GCP_SERVICE_ACCOUNT_BENCHMARKS}}
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
      - name: Run chaos test
        run: ./ann_benchmark_compression_aws.sh
      - id: 'upload-files'
        uses: 'google-github-actions/upload-cloud-storage@v1'
        with:
          path: 'results'
          destination: 'ann-pipelines/github-action-runs'
          glob: '*.json'
  07-ann-benchmarks-pq-glove-aws:
    name: "[bench AWS] Glove100 pq=true"
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY}}
      AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
      DATASET: glove-100-angular
      DISTANCE: cosine
      REQUIRED_RECALL: 0.89
    steps:
      - uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}
      - id: 'gcs_auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: ${{secrets.GCP_SERVICE_ACCOUNT_BENCHMARKS}}
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
      - name: Run chaos test
        run: ./ann_benchmark_compression_aws.sh
      - id: 'upload-files'
        uses: 'google-github-actions/upload-cloud-storage@v1'
        with:
          path: 'results'
          destination: 'ann-pipelines/github-action-runs'
          glob: '*.json'
  08-ann-benchmarks-pq-glove-aws:
    name: "[bench AWS] Glove100 pq=true"
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY}}
      AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
      DATASET: glove-100-angular
      DISTANCE: cosine
      REQUIRED_RECALL: 0.89
    steps:
      - uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}
      - id: 'gcs_auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: ${{secrets.GCP_SERVICE_ACCOUNT_BENCHMARKS}}
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
      - name: Run chaos test
        run: ./ann_benchmark_compression_aws.sh
      - id: 'upload-files'
        uses: 'google-github-actions/upload-cloud-storage@v1'
        with:
          path: 'results'
          destination: 'ann-pipelines/github-action-runs'
          glob: '*.json'
  09-ann-benchmarks-pq-glove-aws:
    name: "[bench AWS] Glove100 pq=true"
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY}}
      AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
      DATASET: glove-100-angular
      DISTANCE: cosine
      REQUIRED_RECALL: 0.89
    steps:
      - uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}
      - id: 'gcs_auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: ${{secrets.GCP_SERVICE_ACCOUNT_BENCHMARKS}}
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
      - name: Run chaos test
        run: ./ann_benchmark_compression_aws.sh
      - id: 'upload-files'
        uses: 'google-github-actions/upload-cloud-storage@v1'
        with:
          path: 'results'
          destination: 'ann-pipelines/github-action-runs'
          glob: '*.json'
  10-ann-benchmarks-pq-glove-aws:
    name: "[bench AWS] Glove100 pq=true"
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY}}
      AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
      DATASET: glove-100-angular
      DISTANCE: cosine
      REQUIRED_RECALL: 0.89
    steps:
      - uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}
      - id: 'gcs_auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: ${{secrets.GCP_SERVICE_ACCOUNT_BENCHMARKS}}
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
      - name: Run chaos test
        run: ./ann_benchmark_compression_aws.sh
      - id: 'upload-files'
        uses: 'google-github-actions/upload-cloud-storage@v1'
        with:
          path: 'results'
          destination: 'ann-pipelines/github-action-runs'
          glob: '*.json'
