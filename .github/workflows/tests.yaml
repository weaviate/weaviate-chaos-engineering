name: Chaos tests

env:
  # WEAVIATE_VERSION: preview-ensure-thread-safety-when-reading-the-schema-d52d392
  MINIMUM_WEAVIATE_VERSION: 1.15.0 # this is used as the start in the upgrade journey test
on:
  push
  
jobs:
  before:
    name: "before: Merge pull request #3214 from weaviate/fix_commit_logger_race2 "
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY}}
      AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
      DATASET: glove-100-angular
      DISTANCE: cosine
      REQUIRED_RECALL: 0.91
      WEAVIATE_VERSION: 1.20.0-prealpha-8330253
    steps:
      - uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}
      - id: 'gcs_auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: ${{secrets.GCP_SERVICE_ACCOUNT_BENCHMARKS}}
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
      - name: Run chaos test
        run: ./ann_benchmark_compression_aws.sh
      - id: 'upload-files'
        uses: 'google-github-actions/upload-cloud-storage@v1'
        with:
          path: 'results'
          destination: 'ann-pipelines/github-action-runs'
          glob: '*.json'
  after:
    name: "after: Merge pull request #3220 from weaviate/linter_fix "
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY}}
      AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
      DATASET: glove-100-angular
      DISTANCE: cosine
      REQUIRED_RECALL: 0.91
      WEAVIATE_VERSION: 1.20.0-prealpha-250c737
    steps:
      - uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}
      - id: 'gcs_auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: ${{secrets.GCP_SERVICE_ACCOUNT_BENCHMARKS}}
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
      - name: Run chaos test
        run: ./ann_benchmark_compression_aws.sh
      - id: 'upload-files'
        uses: 'google-github-actions/upload-cloud-storage@v1'
        with:
          path: 'results'
          destination: 'ann-pipelines/github-action-runs'
          glob: '*.json'
